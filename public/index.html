<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Reservas</title>
  <style>
    body { 
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
    }
    nav { background-color: #0071aa; padding: 15px; }
    nav a {
      color: rgb(255, 250, 241);
      margin-right: 10px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    label { display: block; margin-top: 10px; }
    select, input { padding: 6px; margin-top: 4px; width: 300px; }
    button { margin-top: 20px; padding: 10px 20px; }
    .habitacion { border: 1px solid #ffffff; padding: 10px; margin-bottom: 10px; }
    .error { color: red; }
    .success { color: green; }
  .enlace-centrado {
    text-align: center;
    margin-top: 10px;
  }
  </style>
</head>
<body>

  <nav class="enlace-centrado">
    <a href="#" onclick="mostrarSeccion('buscar')">Buscar Habitaciones</a>
    <a href="#" onclick="mostrarSeccion('reservas')">Lista de Reservas</a>
  </nav>

  <section id="inicio" class="active">
    <h1>BIENVENIDO AL SISTEMA DE RESERVAS</h1>
    <p>Use el men√∫ de navegaci√≥n para buscar habitaciones disponibles o consultar reservas existentes.</p>
  </section>

  <section id="buscar">
    <form id="buscarDisponibilidad">
    <label>Hotel ID:
      <input type="number" name="HotelId" required>
    </label>

    <label>Fecha de Ingreso:
      <input type="date" name="fechaIngreso" required>
    </label>

    <label>Fecha de Salida:
      <input type="date" name="fechaSalida" required>
    </label>

    <label>Cantidad de Personas:
      <input type="number" name="capacidad" min="1" required>
    </label>

    <button type="submit">Buscar Disponibilidad</button>
  </form>

  <div id="resultado"></div>

  <form id="crearReserva" style="display: none;">
    <h3>Resumen de Reserva</h3>
    <p><strong>Hotel:</strong> <span id="reservaHotel"></span></p>
    <p><strong>Fechas:</strong> <span id="reservaFechas"></span></p>
    <p><strong>Personas:</strong> <span id="reservaPersonas"></span></p>

    <label>Seleccione una habitaci√≥n:
      <select name="HabitacionId" required></select>
    </label>

    <label>C√©dula del Cliente:
      <input type="text" name="cedula" required>
    </label>

    <div id="camposCliente">
      <label>Nombre del Cliente:
        <input type="text" name="nombre" required>
      </label>
      <label>Apellido del Cliente:
        <input type="text" name="apellido" required>
      </label>
    </div>

    <input type="hidden" name="HotelId">
    <input type="hidden" name="fechaIngreso">
    <input type="hidden" name="fechaSalida">
    <input type="hidden" name="cantidadPersonas">

    <button type="submit">Crear Reserva</button>
  </form>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const buscarForm = document.getElementById('buscarDisponibilidad');
  const reservaForm = document.getElementById('crearReserva');
  const habitacionSelect = reservaForm.HabitacionId;
  const resultadoDiv = document.getElementById('resultado');

  console.log("üß™ DOM cargado. reservaForm encontrado:", reservaForm);

  function setCamposClienteRequired(requerido) {
  const camposCliente = document.getElementById('camposCliente');
  const nombreInput = reservaForm.nombre;
  const apellidoInput = reservaForm.apellido;
  
  camposCliente.style.display = requerido ? 'block' : 'none';
  nombreInput.required = requerido;
  apellidoInput.required = requerido;
}

    // Verificar si cliente existe al ingresar c√©dula
    reservaForm.cedula.addEventListener('blur', async () => {
      const cedula = reservaForm.cedula.value.trim();
      if (!cedula) {
        setCamposClienteRequired(true); // Mostrar campos si c√©dula est√° vac√≠a
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/clientes?cedula=${cedula}`);
        setCamposClienteRequired(!res.ok); // Mostrar campos solo si cliente no existe
      } catch (error) {
        console.error('Error verificando cliente:', error);
        setCamposClienteRequired(true); // Mostrar campos por si hay error
      }
    });

  buscarForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validaci√≥n de fechas
    const fechaIngreso = new Date(buscarForm.fechaIngreso.value);
    const fechaSalida = new Date(buscarForm.fechaSalida.value);

    if (fechaSalida <= fechaIngreso) {
      resultadoDiv.innerHTML = '<div class="error">‚ùå La fecha de salida debe ser posterior a la de ingreso</div>';
      return;
    }

    resultadoDiv.innerHTML = '<p>Buscando disponibilidad...</p>';

    try {
      const data = {
        HotelId: buscarForm.HotelId.value,
        fechaIngreso: buscarForm.fechaIngreso.value,
        fechaSalida: buscarForm.fechaSalida.value,
        capacidad: buscarForm.capacidad.value
      };

      const params = new URLSearchParams(data);
      const res = await fetch(`http://localhost:3000/reservas/disponibles?${params}`);

      if (!res.ok) {
        throw new Error(await res.text());
      }

      const habitaciones = await res.json();

      if (habitaciones.length === 0) {
        resultadoDiv.innerHTML = '<div class="error">‚ùå No hay habitaciones disponibles para los criterios seleccionados.</div>';
        reservaForm.style.display = 'none';
        return;
      }

      // Mostrar resultados
      resultadoDiv.innerHTML = `
        <h3>Habitaciones Disponibles (${habitaciones.length})</h3>
        ${habitaciones.map(h => `
          <div class="habitacion">
            <strong>Habitaci√≥n ${h.numero}</strong> (Piso ${h.piso})<br>
            Capacidad: ${h.capacidad} personas<br>
            Caracter√≠sticas: ${h.caracteristicas || 'Ninguna especificada'}<br>
          </div>
        `).join('')}
      `;

      // Rellenar formulario de reserva
      habitacionSelect.innerHTML = habitaciones.map(h => 
        `<option value="${h.id}">Habitaci√≥n ${h.numero} (Piso ${h.piso}) - Capacidad: ${h.capacidad}</option>`
      ).join('');

      // Actualizar campos ocultos
      reservaForm.HotelId.value = data.HotelId;
      reservaForm.fechaIngreso.value = data.fechaIngreso;
      reservaForm.fechaSalida.value = data.fechaSalida;
      reservaForm.cantidadPersonas.value = data.capacidad;

      // Actualizar resumen
      document.getElementById('reservaHotel').textContent = `Hotel ID ${data.HotelId}`;
      document.getElementById('reservaFechas').textContent = 
        `${new Date(data.fechaIngreso).toLocaleDateString()} al ${new Date(data.fechaSalida).toLocaleDateString()}`;
      document.getElementById('reservaPersonas').textContent = data.capacidad;

      reservaForm.style.display = 'block';

    } catch (error) {
      resultadoDiv.innerHTML = `<div class="error">‚ùå Error al buscar disponibilidad: ${error.message}</div>`;
      console.error('Error:', error);
    }
  });

  reservaForm.addEventListener('submit', async (e) => {
    console.log("üöÄ Submit de reservaForm ejecutado");
    e.preventDefault();
    resultadoDiv.innerHTML = '<p>Procesando reserva...</p>';
    if (reservaForm.nombre.required && (!reservaForm.nombre.value || !reservaForm.apellido.value)) {
      resultadoDiv.innerHTML = '<div class="error">‚ùå Nombre y apellido son requeridos</div>';
      return;
    }
    try {
      const payload = {
        cedula: reservaForm.cedula.value,
        HotelId: parseInt(reservaForm.HotelId.value),
        HabitacionId: parseInt(reservaForm.HabitacionId.value),
        fechaIngreso: reservaForm.fechaIngreso.value,
        fechaSalida: reservaForm.fechaSalida.value,
        cantidadPersonas: parseInt(reservaForm.cantidadPersonas.value),
        nombre: reservaForm.nombre?.value || '',
        apellido: reservaForm.apellido?.value || ''
      };

      console.log("üì¶ Payload a enviar:", payload);

      const res = await fetch('http://localhost:3000/reservas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const respuesta = await res.json();

      if (res.ok) {
        resultadoDiv.innerHTML = `
          <div class="success">
            <h3>‚úÖ Reserva exitosa</h3>
            <p><strong>N√∫mero de reserva:</strong> ${respuesta.reserva.id}</p>
            <p><strong>Habitaci√≥n:</strong> ${respuesta.reserva.habitacion.numero} (Piso ${respuesta.reserva.habitacion.piso})</p>
            <p><strong>Fechas:</strong> ${new Date(respuesta.reserva.fechaIngreso).toLocaleDateString()} al ${new Date(respuesta.reserva.fechaSalida).toLocaleDateString()}</p>
          </div>
        `;
        reservaForm.reset();
        reservaForm.style.display = 'none';
        document.getElementById('camposCliente').style.display = 'none';
      } else {
        throw new Error(respuesta.error || 'Error desconocido');
      }
    } catch (error) {
      let msg = error.message;
      try {
        const errJson = await error.response.json();
        if (errJson.error) msg = errJson.error;
      } catch {}

      resultadoDiv.innerHTML = `<div class="error">‚ùå Error al crear reserva: ${msg}</div>`;
      console.error('Error:', error);
    }

  });
});
</script>
  </section>

  <section id="reservas">
    <form id="formReservas">
  <label>Hotel ID:
    <input type="number" name="HotelId" required>
  </label>

  <label>Fecha de Ingreso:
    <input type="date" name="fechaIngreso" required>
  </label>

  <label>Fecha de Salida (opcional):
    <input type="date" name="fechaSalida">
  </label>

  <label>C√©dula del Cliente (opcional):
    <input type="text" name="cedula">
  </label>

  <button type="submit">Buscar Reservas</button>
</form>

<div id="listaReservas"></div>

<script>
  const formReservas = document.getElementById('formReservas');
  const listaReservasDiv = document.getElementById('listaReservas');

  formReservas.addEventListener('submit', async (e) => {
    e.preventDefault();
    listaReservasDiv.innerHTML = '<p>Buscando reservas...</p>';

    const data = {
      HotelId: formReservas.HotelId.value,
      fechaIngreso: formReservas.fechaIngreso.value,
      fechaSalida: formReservas.fechaSalida.value,
      cedula: formReservas.cedula.value
    };

    const params = new URLSearchParams();
    params.append("HotelId", data.HotelId);
    params.append("fechaIngreso", data.fechaIngreso);
    if (data.fechaSalida) params.append("fechaSalida", data.fechaSalida);
    if (data.cedula) params.append("cedula", data.cedula);

    try {
      const res = await fetch(`http://localhost:3000/reservas?${params}`);
      if (!res.ok) throw new Error(await res.text());

      const reservas = await res.json();

      if (reservas.length === 0) {
        listaReservasDiv.innerHTML = '<div class="error">‚ùå No se encontraron reservas con los filtros indicados.</div>';
        return;
      }

      // Ordenar reservas (fecha, piso, n√∫mero)
      reservas.sort((a, b) => {
        const fechaA = new Date(a.fechaIngreso), fechaB = new Date(b.fechaIngreso);
        if (fechaA - fechaB !== 0) return fechaA - fechaB;
        if (a.Habitacion.piso - b.Habitacion.piso !== 0) return a.Habitacion.piso - b.Habitacion.piso;
        return a.Habitacion.numero - b.Habitacion.numero;
      });

      listaReservasDiv.innerHTML = `
        <h3>Reservas encontradas (${reservas.length})</h3>
        ${reservas.map(r => `
          <div class="habitacion">
            <strong>Reserva ID:</strong> ${r.id}<br>
            <strong>Cliente:</strong> ${r.Cliente.nombre} ${r.Cliente.apellido} (${r.Cliente.cedula})<br>
            <strong>Fecha:</strong> ${new Date(r.fechaIngreso).toLocaleDateString()} al ${new Date(r.fechaSalida).toLocaleDateString()}<br>
            <strong>Habitaci√≥n:</strong> ${r.Habitacion.numero} (Piso ${r.Habitacion.piso})<br>
            <strong>Capacidad:</strong> ${r.Habitacion.capacidad} personas<br>
          </div>
        `).join('')}
      `;

    } catch (error) {
      listaReservasDiv.innerHTML = `<div class="error">‚ùå Error al buscar reservas: ${error.message}</div>`;
      console.error('Error al buscar reservas:', error);
    }
  });
</script>
  </section>

  <script>
    function mostrarSeccion(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
  </script>

</body>
</html>
